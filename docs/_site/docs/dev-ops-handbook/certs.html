<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/WADTFY/wadtfy-docs/assets/css/just-the-docs-default.css"> <script src="/WADTFY/wadtfy-docs/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script> <script src="/WADTFY/wadtfy-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Certs | UNITY</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Certs" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="UNITY Docs" /> <meta property="og:description" content="UNITY Docs" /> <link rel="canonical" href="https://pages.atc-github.azure.cloud.bmw/UNITY/unity//WADTFY/wadtfy-docs/dev-ops-handbook/certs.html" /> <meta property="og:url" content="https://pages.atc-github.azure.cloud.bmw/UNITY/unity//WADTFY/wadtfy-docs/dev-ops-handbook/certs.html" /> <meta property="og:site_name" content="UNITY" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Certs" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"UNITY Docs","headline":"Certs","url":"https://pages.atc-github.azure.cloud.bmw/UNITY/unity//WADTFY/wadtfy-docs/dev-ops-handbook/certs.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/WADTFY/wadtfy-docs/" class="site-title lh-tight"> UNITY </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/WADTFY/wadtfy-docs/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/WADTFY/wadtfy-docs/Terms-of-Service.html" class="nav-list-link">Terms of Service</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in AppDev Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/app-dev-handbook/" class="nav-list-link">AppDev Handbook</a><ul class="nav-list "><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/getting-started.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/unity-app-yaml.html" class="nav-list-link">Unity App Yaml</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/connect-it.html" class="nav-list-link">Connect IT</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/app-configuration.html" class="nav-list-link">App Configuration</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/authentication-and-authorization.html" class="nav-list-link">Authentication and Authorization</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/resources.html" class="nav-list-link">Resources</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/urls.html" class="nav-list-link">URLs</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/certificates.html" class="nav-list-link">Certificates</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/security.html" class="nav-list-link">Security</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/telemetry.html" class="nav-list-link">Telemetry</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/external-services.html" class="nav-list-link">External Services</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/http-headers.html" class="nav-list-link">HTTP Headers</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/maven-packages.html" class="nav-list-link">Maven Packages</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/kubernetes.html" class="nav-list-link">Kubernetes</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/diagnostics.html" class="nav-list-link">Diagnostics</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/postgresql-flexible-server.html" class="nav-list-link">PostgreSQL Flexible Server</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/app-dev-handbook/decommissioning-app.html" class="nav-list-link">Decommission App</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in DevOps Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/" class="nav-list-link">DevOps Handbook</a><ul class="nav-list "><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/architecture.html" class="nav-list-link">Architecture</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/networking.html" class="nav-list-link">Networking</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/kubernetes.html" class="nav-list-link">Kubernetes</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/envoy.html" class="nav-list-link">Envoy</a></li><li class="nav-list-item active"><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/certs.html" class="nav-list-link active">Certs</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/technical-accounts.html" class="nav-list-link">Technical Accounts</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/regular-activities.html" class="nav-list-link">Regular Activities</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/incident-recovery.html" class="nav-list-link">Incident Recovery</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/database-incident-recovery.html" class="nav-list-link">Database Incident Recovery</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/alerts.html" class="nav-list-link">Alerts</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/restore-decommissioned-app.html" class="nav-list-link">Restore decommission App</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/cluster-migration.html" class="nav-list-link">Cluster Migration</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/references.html" class="nav-list-link">References</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/accesses.html" class="nav-list-link">Accesses</a></li><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/postgresql-flexible-server.html" class="nav-list-link">PostgreSQL Flexible Server</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search UNITY" aria-label="Search UNITY" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://unity-int.bmwgroup.net" class="site-button" > Int </a> </li> <li class="aux-nav-list-item"> <a href="https://unity.bmwgroup.net" class="site-button" > Prod </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/WADTFY/wadtfy-docs/dev-ops-handbook/">DevOps Handbook</a></li> <li class="breadcrumb-nav-list-item"><span>Certs</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><strong>Table of Contents</strong></p> <!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> <ul> <li><a href="#certs">Certs</a> <ul> <li><a href="#architecture">Architecture</a></li> <li><a href="#tls">TLS</a></li> <li><a href="#how-to-inspect-certificates">How to Inspect Certificates</a></li> <li><a href="#client-to-ingress-controller">Client to Ingress Controller</a></li> <li><a href="#ingress-controller-to-pod">Ingress Controller to Pod</a></li> </ul> </li> </ul> <!-- END doctoc generated TOC please keep comment here to allow auto update --> <h1 id="certs"> <a href="#certs" class="anchor-heading" aria-labelledby="certs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Certs </h1> <p>Unity handles all certificate management for an app. This means that app developers can develop an entire backend without ever needing to touch a certificate or trust store.</p> <h2 id="architecture"> <a href="#architecture" class="anchor-heading" aria-labelledby="architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture </h2> <p>In UNITY, all HTTP traffic is encrypted using TLS. Encryption is handled by different certificates, as outlined below:</p> <ul> <li>Client to ingress controller</li> <li>Ingress controller to Pod</li> </ul><pre><code class="language-mermaid">graph TB
    client-- "unity.bmwgroup.net (BMW root signed)" --&gt;ingress-controller

    subgraph K8s
      unity-certificate&gt;unity-certificate]-. "cert manager generates (BMW root signed)" .-&gt;unity-tls&gt;unity-tls]
      unity-tls&gt;unity-tls]-."kyverno generates key with CA (tmp)" .-&gt;unity-tls-with-ca&gt;unity-tls-with-ca]
      bmw-certificates&gt;bmw-certificates]-. "trust" .-&gt;ingress-controller

      unity-tls-with-ca-."encrypt" .-&gt;ingress-controller
      ingress-controller-- "unity.bmwgroup.net (BMW root signed)" --&gt;envoy
      bmw-certificates&gt;bmw-certificates]-. "trust" .-&gt;envoy
      unity-tls&gt;unity-tls]-."encrypt" .-&gt;envoy

      subgraph pod
          envoy-- "http (in memory)" --&gt;main
      end
    end
</code></pre><p>The sections below outline the details.</p> <h2 id="tls"> <a href="#tls" class="anchor-heading" aria-labelledby="tls"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> TLS </h2> <p>When an end-user opens a UNITY app’s UI in the web browser, they call a URL like <code class="language-plaintext highlighter-rouge">https://unity.bmwgroup.net/foo/ui</code>. The request is handled by the ingress controller of the Kubernetes cluster, which also terminates TLS.</p> <p>The ingress controller is configured via an <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/"><code class="language-plaintext highlighter-rouge">Ingress</code></a> object, configured via the <a href="https://atc-github.azure.cloud.bmw/UNITY/unity-helm-charts/tree/main/charts/unity-app">unity-app</a> Helm chart.</p> <p>The <a href="https://github.com/kubernetes/ingress-nginx">nginx ingress controller</a> can be configured via <a href="https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md">annotations</a> to handle TLS correctly.</p> <p>All ingress objects MUST have the following annotations set:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">nginx.ingress.kubernetes.io/backend-protocol</span><span class="pi">:</span> <span class="s">HTTPS</span>
<span class="na">nginx.ingress.kubernetes.io/proxy-ssl-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;service</span><span class="nv"> </span><span class="s">name&gt;.&lt;namespace&gt;.svc.cluster.local"</span>
<span class="na">nginx.ingress.kubernetes.io/proxy-ssl-secret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;namespace&gt;/&lt;secret</span><span class="nv"> </span><span class="s">name&gt;"</span>
<span class="na">nginx.ingress.kubernetes.io/proxy-ssl-verify</span><span class="pi">:</span> <span class="s2">"</span><span class="s">on"</span>
</code></pre></div></div> <p>These annotations ensure that TLS is terminated by the ingress controller and re-encrypted on the upstream. To terminate TLS using a certificate that is signed by a BMW certificate authority, the <a href="https://cert-manager.io">cert-manager</a> is employed.</p> <p>The cert manager handles a <a href="https://cert-manager.io/docs/usage/certificate/"><code class="language-plaintext highlighter-rouge">Certificate</code></a> CRD, which instructs the cert manager to generate a certificate and store it in a secret.</p> <p>Then a <a href="https://kyverno.io/policies/">Kyverno policy</a> creates another secret that contains the generated server certificate as well as the intermediate CA. This is a temporary solution by 4Wheels Managed to <a href="https://developer.bmwgroup.net/docs/4wheels-managed/applications_integration/certificates/#serve-intermediate-certificates">serve intermediate certificates</a></p> <p>Additional infoformation can be found in the <a href="https://developer.bmwgroup.net/docs/4wheels-managed/applications_integration/certificates/">Certificates</a> documentation.</p> <p>Upstream traffic from the ingress controller to the pod (Envoy) is also handled by BMW signed certificates. In the pod, TLS is terminated by an <a href="https://www.envoyproxy.io">envoy proxy</a>.</p> <p>Envoy’s <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/security/secret#example-three-certificate-rotation-for-xds-grpc-connection">Secret Discovery Service (SDS)</a> automatically picks up new certificates, whenever the content of the mounted secret changes, without restarting the Envoy container. This ensures that certificates can be rotated without restarting any containers or pods.</p> <p>The configuration of the Envoy proxy is also part of the <a href="https://atc-github.azure.cloud.bmw/UNITY/unity-helm-charts/tree/main/charts/unity-app">unity-app</a> Helm chart. Finally, the Envoy proxy passes traffic to the app’s main container within the pod without encryption via HTTP. By terminating TLS at the Envoy, the app’s main container does not need to handle any certificates or secrets.</p> <h2 id="how-to-inspect-certificates"> <a href="#how-to-inspect-certificates" class="anchor-heading" aria-labelledby="how-to-inspect-certificates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to Inspect Certificates </h2> <p>When something breaks, it is important to know how to inspect the various certificates.</p> <p>If the ingress controller stops serving traffic, one possible reason could be an issue with the certificate configuration. The first step for troubleshooting should be inspecting the logs in Grafana Loki:</p> <p><img src="../assets/Loki-SSL-certificate-veryfy-error-Screenshot.png" alt="" /></p> <p>Next, the certificates can be inspected locally as follows.</p> <h2 id="client-to-ingress-controller"> <a href="#client-to-ingress-controller" class="anchor-heading" aria-labelledby="client-to-ingress-controller"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Client to Ingress Controller </h2> <p>To inspect the client to ingress controller certificate, you would need to run the following scripts:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get certificate <span class="nt">-oyaml</span> unity-certificate
</code></pre></div></div> <p>The certificates can be extracted from the secret where the cert manager stores them using the following commands:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secrets unity-tls <span class="nt">-ojson</span> | jq <span class="s1">'.data["tls.key"] | @base64d'</span> <span class="nt">-r</span> <span class="o">&gt;</span> tls.key
kubectl get secrets unity-tls <span class="nt">-ojson</span> | jq <span class="s1">'.data["tls.crt"] | @base64d'</span> <span class="nt">-r</span> <span class="o">&gt;</span> tls.crt

kubectl get secrets unity-tls-with-ca <span class="nt">-ojson</span> | jq <span class="s1">'.data["tls.crt"] | @base64d'</span> <span class="nt">-r</span> <span class="o">&gt;</span> tls-with-ca.crt
</code></pre></div></div> <p>Using <code class="language-plaintext highlighter-rouge">openssl</code>, you can display the contents of the certificate:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>tls.crt | openssl x509 <span class="nt">-noout</span> <span class="nt">-text</span> <span class="nt">-certopt</span> no_header,no_version,no_serial,no_signame,no_issuer,no_pubkey,no_sigdump,no_aux
</code></pre></div></div> <p>To validate whether a certificate key and crt match, you can compare the checksums using the following commands:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CRT_MD5</span><span class="o">=</span><span class="si">$(</span>openssl x509 <span class="nt">-noout</span> <span class="nt">-modulus</span> <span class="nt">-in</span> tls.crt | openssl md5<span class="si">)</span>
<span class="nv">KEY_MD5</span><span class="o">=</span><span class="si">$(</span>openssl rsa <span class="nt">-noout</span> <span class="nt">-modulus</span> <span class="nt">-in</span> tls.key | openssl md5<span class="si">)</span>
<span class="nb">echo</span> <span class="nv">$CRT_MD5</span>
<span class="nb">echo</span> <span class="nv">$KEY_MD5</span>
<span class="nb">echo</span> <span class="s2">"diff:"</span>
diff &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$CRT_MD5</span><span class="s2">"</span><span class="o">)</span> &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$KEY_MD5</span><span class="s2">"</span><span class="o">)</span>
</code></pre></div></div> <p>If the checksums are equal (the diff is empty), the pair is valid.</p> <h2 id="ingress-controller-to-pod"> <a href="#ingress-controller-to-pod" class="anchor-heading" aria-labelledby="ingress-controller-to-pod"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Ingress Controller to Pod </h2> <p>TLS from the ingress controller to the service (pod) is handled by the same certificate.</p> <p>To ensure that the pod is serving traffic with the certificate from the secret (and not using an outdated certificate, e.g. after the certificate was rotated to a new one), you can map the port of the service to localhost using the following command:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAME</span><span class="o">=</span>&lt;name of the app, e.g. services&gt;
<span class="nv">DEPLOYMENT</span><span class="o">=</span>&lt;name of the deployment, e.g. api&gt;

kubectl port-forward svc/app-<span class="nv">$NAME</span>-<span class="nv">$DEPLOYMENT</span> 8000:8000
</code></pre></div></div> <p>Then, in a separate shell, you can connect to the mapped port and dump the served certificate:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl s_client <span class="nt">-showcerts</span> <span class="nt">-connect</span> localhost:8000 <span class="nt">-servername</span> app-<span class="nv">$NAME</span>-<span class="nv">$DEPLOYMENT</span> &lt;/dev/null 2&gt;/dev/null
</code></pre></div></div> <p>Make sure the served certificate is the same as the one from the secret:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secret unity-tls <span class="nt">-ojson</span> | jq <span class="nt">-r</span> <span class="s1">'.data["tls.crt"] | @base64d'</span>
</code></pre></div></div> <p>The ingress controller should trust this certificate, which is configured in the following annotation:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get ingress app-<span class="nv">$NAME</span>-<span class="nv">$DEPLOYMENT</span> <span class="nt">-ojson</span> | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations["nginx.ingress.kubernetes.io/proxy-ssl-secret"]'</span>
</code></pre></div></div> <p>It is also crucial that <code class="language-plaintext highlighter-rouge">nginx.ingress.kubernetes.io/proxy-ssl-verify</code> is set to <code class="language-plaintext highlighter-rouge">on</code> and <code class="language-plaintext highlighter-rouge">nginx.ingress.kubernetes.io/proxy-ssl-name</code> is set to a value in the certificate. You can validate this with the following command:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SNI</span><span class="o">=</span><span class="si">$(</span>kubectl get ingress app-<span class="nv">$NAME</span>-<span class="nv">$DEPLOYMENT</span> <span class="nt">-ojson</span> | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations["nginx.ingress.kubernetes.io/proxy-ssl-name"]'</span><span class="si">)</span>
<span class="nb">cat </span>svc-tls.crt | openssl x509 <span class="nt">-noout</span> <span class="nt">-text</span> <span class="nt">-certopt</span> no_header,no_version,no_serial,no_signame,no_issuer,no_pubkey,no_sigdump,no_aux | <span class="nb">grep</span> <span class="nv">$SNI</span>
</code></pre></div></div> <p>Finally, it may still be possible that one of the pods backing the service is serving the correct certificate while another one does not. To ensure this, map the port of the individual pods instead of mapping the service port and repeat the certificate validation.</p> </div> </div> <div class="search-overlay"></div> </div> <script> var config = { theme: "dark" } ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
