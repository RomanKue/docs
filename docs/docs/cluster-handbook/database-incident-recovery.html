<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/WADTFY/wadtfy-docs/assets/css/just-the-docs-default.css"> <script src="/WADTFY/wadtfy-docs/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script> <script src="/WADTFY/wadtfy-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Database Incident Recovery | WADTFY</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Database Incident Recovery" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="WADTFY Docs" /> <meta property="og:description" content="WADTFY Docs" /> <link rel="canonical" href="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/cluster-handbook/database-incident-recovery.html" /> <meta property="og:url" content="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/cluster-handbook/database-incident-recovery.html" /> <meta property="og:site_name" content="WADTFY" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Database Incident Recovery" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"WADTFY Docs","headline":"Database Incident Recovery","url":"https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/cluster-handbook/database-incident-recovery.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/WADTFY/wadtfy-docs/" class="site-title lh-tight"> WADTFY </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/WADTFY/wadtfy-docs/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Onboarding Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/onboarding-handbook/" class="nav-list-link">Onboarding Handbook</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Cluster Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/cluster-handbook/" class="nav-list-link">Cluster Handbook</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search WADTFY" aria-label="Search WADTFY" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://argocd.api-i.bmwgroup.net" class="site-button" > Int </a> </li> <li class="aux-nav-list-item"> <a href="https://argocd.api.bmwgroup.net" class="site-button" > Prod </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">DevOps Handbook</a></li> <li class="breadcrumb-nav-list-item"><span>Database Incident Recovery</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><strong>Table of Contents</strong></p> <!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> <ul> <li><a href="#database-incident-recovery">Database Incident Recovery</a> <ul> <li><a href="#restore-database-manually">Restore Database Manually</a></li> <li><a href="#fix-terraform-locked-state">Fix Terraform Locked State</a></li> <li><a href="#cleanup-resources-when-destroy-is-interrupted">Cleanup Resources When Destroy Is Interrupted</a></li> <li><a href="#manually-run-terraform-destroy-from-local">Manually Run Terraform Destroy From Local</a></li> <li><a href="#manually-delete-database-resources">Manually Delete Database Resources</a></li> </ul> </li> </ul> <!-- END doctoc generated TOC please keep comment here to allow auto update --> <h1 id="database-incident-recovery"> <a href="#database-incident-recovery" class="anchor-heading" aria-labelledby="database-incident-recovery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database Incident Recovery </h1> <p>The sections below describe certain incidents related to databases and how to recover from them.</p> <h2 id="restore-database-manually"> <a href="#restore-database-manually" class="anchor-heading" aria-labelledby="restore-database-manually"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Restore Database Manually </h2> <p>In case a manual restore of the database server is needed (e.g. the server was accidentally deleted) it can be done by following these steps:</p> <ol> <li>Recreate the azure resources for the database server through the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code> with the exact same configuration. You can get the last configuration from the git history of the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code> file. Alternatively you can undelete the container of the database in the azure portal, this should also contain the required configuration(⚠️In this case don’t forget to delete the container again before recreating the resources).</li> <li>In the backup storage account (azure portal): delete the newly created blob container and undelete the container containing the backup to be restored (⚠️check the last modified timestamps, the names will be the same). <img src="../assets/undelete-container.png" alt="" /></li> <li> <p>Create a secret with one of the access keys of the backup storage account. This secret will be used to mount the azure file share containing the backup in the container to later restore it.</p> <p><img src="../assets/storage-account-access-key.png" alt="" /></p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">app-test-pfs-db-foo-storage-account</span>
   <span class="na">namespace</span><span class="pi">:</span> <span class="s">test</span>
 <span class="na">stringData</span><span class="pi">:</span>
   <span class="na">azurestorageaccountname</span><span class="pi">:</span> <span class="s">unitytestbackupv1</span> <span class="c1"># the name of the storage account containing the backups</span>
   <span class="na">azurestorageaccountkey</span><span class="pi">:</span> <span class="s">unitytestbackupv1_acceskey</span> <span class="c1"># one of the access keys to the storage account containing the backups</span>
 <span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
</code></pre></div> </div> </li> <li> <p>Create a job to restore the DB Server. The job has two steps, first the <code class="language-plaintext highlighter-rouge">initContainer</code> copies the backup from the blob container to the azure file share then the backup will be restored into the database server created in the first step.</p> <p>In the following example you can replace all the occurrences of <code class="language-plaintext highlighter-rouge">app-test-pfs-db-foo</code> with your database name. Every credential and certificate required is saved in the <a href="https://atc-github.azure.cloud.bmw/UNITY/keepass">keepass repo</a>, or you can run the <a href="https://atc-github.azure.cloud.bmw/UNITY/unity-terraform/actions/workflows/store-secrets.yaml">store-secrets</a> workflow in the <code class="language-plaintext highlighter-rouge">unity-terraform</code> repo to get them. The Service Principle certificate can be encoded in <code class="language-plaintext highlighter-rouge">base64</code> using any linux terminal (e.g. in GitBash <code class="language-plaintext highlighter-rouge">cat /path/to/certificate | base64</code>). ️The container image must contain the <a href="https://www.postgresql.org/docs/current/app-psql.html"><code class="language-plaintext highlighter-rouge">psql</code></a> with the postgres version specified in step 1.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">app-test-pfs-db-foo-restore-backup</span>
   <span class="na">namespace</span><span class="pi">:</span> <span class="s">test</span>
   <span class="na">labels</span><span class="pi">:</span>
     <span class="na">unity.bmwgroup.net/restore-database-backup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">app-test-pfs-db-foo"</span>
 <span class="na">spec</span><span class="pi">:</span>
   <span class="na">template</span><span class="pi">:</span>
     <span class="na">spec</span><span class="pi">:</span>
       <span class="na">initContainers</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">-c</span>
         <span class="pi">-</span> <span class="s">echo $AZURE_CLIENT_CERT_PFX_B64 | base64 -d &gt; $AZCOPY_SPA_CERT_PATH;</span>
           <span class="s">mkdir /backupfileshare/app-test-pfs-db-foo;</span>
           <span class="s">azcopy copy "https://unitytestbackupv1.blob.core.windows.net/app-test-pfs-db-foo/app-test-pfs-db-foo.tar" /backupfileshare/app-test-pfs-db-foo;</span>
         <span class="na">command</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">sh</span>
         <span class="na">env</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_AUTO_LOGIN_TYPE</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">SPN</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_TENANT_ID</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">tenant-id</span> <span class="c1"># the azure tenant id</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_SPA_CERT_PATH</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">/tmp/cert.pfx</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_SPA_APPLICATION_ID</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">application-id</span> <span class="c1"># the client id of the service principal</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_LOG_LOCATION</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">/tmp</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZCOPY_JOB_PLAN_LOCATION</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">/tmp</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AZURE_CLIENT_CERT_PFX_B64</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">client-certificate</span> <span class="c1"># the certificate to the SP base64 encoded</span>
         <span class="na">image</span><span class="pi">:</span> <span class="s">containers.atc-github.azure.cloud.bmw/unity/azcopy:2023-07-04t082112z-52b72fd</span> <span class="c1"># the latest azcopy image</span>
         <span class="na">name</span><span class="pi">:</span> <span class="s">blob-to-fileshare</span>
         <span class="na">resources</span><span class="pi">:</span>
           <span class="na">limits</span><span class="pi">:</span>
             <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
             <span class="na">memory</span><span class="pi">:</span> <span class="s">512Mi</span>
           <span class="na">requests</span><span class="pi">:</span>
             <span class="na">cpu</span><span class="pi">:</span> <span class="s">200m</span>
             <span class="na">memory</span><span class="pi">:</span> <span class="s">256Mi</span>
         <span class="na">securityContext</span><span class="pi">:</span>
           <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
           <span class="na">capabilities</span><span class="pi">:</span>
             <span class="na">drop</span><span class="pi">:</span>
             <span class="pi">-</span> <span class="s">ALL</span>
           <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">false</span>
         <span class="na">volumeMounts</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/backupfileshare</span>
           <span class="na">name</span><span class="pi">:</span> <span class="s">backupfileshare</span>
       <span class="na">imagePullSecrets</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">containers.atc-github.azure.cloud.bmw</span>
       <span class="na">containers</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">-c</span>
         <span class="pi">-</span> <span class="pi">|</span>
           <span class="s">set -eux</span>
           <span class="s">cd /backupfileshare/db-foo</span>
           <span class="s">tar -xvmpf db-foo.tar</span>
           <span class="s">gzip -d -c backup-all.gz &gt; backup-all.out</span>
           <span class="s">psql -f backup-all.out postgres</span>
           <span class="s">rm backup-all.gz</span>
           <span class="s">rm backup-all.out</span>
           <span class="s">gzip -d -c backup-postgres.gz &gt; backup-postgres.out</span>
           <span class="s">psql -f backup-postgres.out postgres</span>
           <span class="s">rm backup-postgres.gz</span>
           <span class="s">rm backup-postgres.out</span>
         <span class="na">command</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">bash</span>
         <span class="na">env</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGHOST</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">app-test-pfs-db-foo.postgres.database.azure.com</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGUSER</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">postgres</span> <span class="c1"># the postgres admin</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGPASSWORD</span>
           <span class="na">value</span><span class="pi">:</span> <span class="s">password</span> <span class="c1"># the admin password</span>
         <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:14</span> <span class="c1"># the image must contain the required postgres version</span>
         <span class="na">name</span><span class="pi">:</span> <span class="s">restore</span>
         <span class="na">resources</span><span class="pi">:</span>
           <span class="na">limits</span><span class="pi">:</span>
             <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
             <span class="na">memory</span><span class="pi">:</span> <span class="s">512Mi</span>
           <span class="na">requests</span><span class="pi">:</span>
             <span class="na">cpu</span><span class="pi">:</span> <span class="s">200m</span>
             <span class="na">memory</span><span class="pi">:</span> <span class="s">256Mi</span>
         <span class="na">securityContext</span><span class="pi">:</span>
           <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
           <span class="na">capabilities</span><span class="pi">:</span>
             <span class="na">drop</span><span class="pi">:</span>
             <span class="pi">-</span> <span class="s">ALL</span>
           <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">false</span>
         <span class="na">volumeMounts</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/backupfileshare</span>
           <span class="na">name</span><span class="pi">:</span> <span class="s">backupfileshare</span>
       <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
       <span class="na">securityContext</span><span class="pi">:</span>
         <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
         <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">10000</span>
         <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">10000</span>
         <span class="na">seccompProfile</span><span class="pi">:</span>
           <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
       <span class="na">volumes</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">csi</span><span class="pi">:</span>
           <span class="na">driver</span><span class="pi">:</span> <span class="s">file.csi.azure.com</span>
           <span class="na">volumeAttributes</span><span class="pi">:</span>
             <span class="na">secretName</span><span class="pi">:</span> <span class="s">app-test-pfs-db-foo-storage-account</span> <span class="c1"># the name of the secret from step 3</span>
             <span class="na">shareName</span><span class="pi">:</span> <span class="s">app-test-pfs-db-foo</span>
         <span class="na">name</span><span class="pi">:</span> <span class="s">backupfileshare</span>
   <span class="na">ttlSecondsAfterFinished</span><span class="pi">:</span> <span class="m">86400</span>
</code></pre></div> </div> <p>⚠️It’s important to add the <code class="language-plaintext highlighter-rouge">unity.bmwgroup.net/restore-database-backup</code> label with the proper value (<code class="language-plaintext highlighter-rouge">&lt;app-name&gt;-pfs-&lt;database-server-name&gt;</code>), this will prevent the operator to execute any update on the database during the restore process.</p> <p>⚠️Also please note that when trying to restore a large database, it might be necessary to increase the resources (of both the initContainer and the main container).</p> </li> <li>After the job is done verify the logs in grafana. It is possible that there are some errors related to database objects managed by azure and/or the default <code class="language-plaintext highlighter-rouge">postgres</code> database, because the postgres admin user is not a superuser, to whom azure does not give access. If there isn’t any error related to the database(s) managed by the application and the restore was successful delete the secret created in step 3.</li> </ol> <h2 id="fix-terraform-locked-state"> <a href="#fix-terraform-locked-state" class="anchor-heading" aria-labelledby="fix-terraform-locked-state"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Fix Terraform Locked State </h2> <p>Sometimes it might happen that all terraform operations fail because of being in a locked state. There are two possibilities to recover from this situation:</p> <ul> <li> <p>via the Azure portal UI, the lease can be broken: <img src="../assets/unlock.png" alt="" /></p> </li> <li> <p>by running the Terraform command <code class="language-plaintext highlighter-rouge">force-unlock</code></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>azcopy login
azcopy copy https://unitytestv3.blob.core.windows.net/unity-grafana-test <span class="nb">.</span> <span class="nt">--recursive</span>
<span class="nb">cd </span>unity-grafana-test
terraform force-unlock &lt;LOCK_ID&gt;
</code></pre></div> </div> </li> </ul> <h2 id="cleanup-resources-when-destroy-is-interrupted"> <a href="#cleanup-resources-when-destroy-is-interrupted" class="anchor-heading" aria-labelledby="cleanup-resources-when-destroy-is-interrupted"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cleanup Resources When Destroy Is Interrupted </h2> <p>There are cases when the database destroy operation is interrupted for various reasons. The most common reason is when the unity operator is restarted while destroy operation was in progress.</p> <p>Steps to follow:</p> <ul> <li>Check to see if the database container is in a locked stated and if its unlock it, see: <a href="#fix-terraform-locked-state">Fix Terraform Locked State</a></li> <li>If the secret do not exist, add secret of type <code class="language-plaintext highlighter-rouge">postgresql-flexible-server/destroy</code> manually for that database, e.g.: <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Make sure you adapt the names accordingly</span>
kubectl apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Secret
metadata:
annotations:
  unity-operator.unity.bmwgroup.net/azure-resource-group-name: app-test
  unity-operator.unity.bmwgroup.net/disabled: "false"
labels:
  app.kubernetes.io/managed-by: unity
  app.kubernetes.io/name: app-test-pfs-db-attila-azure-restore-v3-manually-added
  unity-operator.unity.bmwgroup.net/postgresql-flexible-server-secret-name: app-test-pfs-db-attila-azure-restore-v3
name: app-test-pfs-db-attila-azure-restore-v3-manually-added
namespace: test
type: postgresql-flexible-server/destroy
</span><span class="no">EOF
</span></code></pre></div> </div> <p>and if the secret exists, just edit the secret, e.g. add a random label, to trigger the reconciliation loop.</p> </li> <li>Checkout unity-operator logs to see if destroy was done with success. If not, delete the secret manually, fix the issue from logs (if you can) and repeat the process</li> <li>If you get an error message like: <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Job 110449 failed with<span class="se">\n</span>status: 500 and message: <span class="se">\"</span>ERROR : A problem occurred. - Failed to perform<span class="se">\n</span><span class="s1">'read'</span> on resource<span class="o">(</span>s<span class="o">)</span> of <span class="nb">type</span> <span class="s1">'privateDnsZones/virtualNetworkLinks'</span>
</code></pre></div> </div> <p>just edit the secret again, add a random label to trigger the reconciliation loop again (you might get lucky). This is an error message coming from <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a>. If the job still fails, open an incident to <code class="language-plaintext highlighter-rouge">public-cloud-framework:global</code></p> </li> <li>If the above steps did not work, follow <a href="#manually-run-terraform-destroy-from-local">Manually Run Terraform Destroy From Local</a></li> </ul> <h2 id="manually-run-terraform-destroy-from-local"> <a href="#manually-run-terraform-destroy-from-local" class="anchor-heading" aria-labelledby="manually-run-terraform-destroy-from-local"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manually Run Terraform Destroy From Local </h2> <p>In some cases the automatic destroy fails without being interrupted, for example: When someone creates a new DB server with an invalid configuration (e.g. too early PITR time stamp). Terraform will not be able to create the Server. When trying to delete that DB server, the destroy change request will fail, because the backup job cannot be executed, because there is no fqdn in the terraform output, e.g. error: <code class="language-plaintext highlighter-rouge">"could not read outputs: terraform output empty for \"fqdn\""</code>.</p> <p>Steps to follow:</p> <ul> <li>Download terraform files from db related container, e.g. <img src="../assets/terraform-files-container.jpg" alt="" /></li> <li>Unzip terraform files</li> <li>Run <code class="language-plaintext highlighter-rouge">terraform init</code></li> <li>Run <code class="language-plaintext highlighter-rouge">terraform destroy</code></li> </ul> <p>If the above steps do not succeed you should follow <a href="#manually-delete-database-resources">Manually Delete Database Resources</a></p> <h2 id="manually-delete-database-resources"> <a href="#manually-delete-database-resources" class="anchor-heading" aria-labelledby="manually-delete-database-resources"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manually Delete Database Resources </h2> <p>When you are in a state where the automatic or semi-automatic ways do not succeed, you will need to delete the resources manually.</p> <p>To do so, first you need to check if you can see the Private DNS zones and VNETs used by your db server in <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a> and if you see them, delete them from there, if not delete them from <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</p> <p>Steps to delete a VNET:</p> <ol> <li>Identify the VNET from <code class="language-plaintext highlighter-rouge">Azure Database for PostgreSQL flexible server</code> view resource in <a href="https://portal.azure.com/">https://portal.azure.com/</a> -&gt; Networking tab -&gt; Virtual network section</li> <li>Make sure the VNET in question is delegated to <code class="language-plaintext highlighter-rouge">Microsoft.DBforPostgreSQL/flexibleServers</code>. You can see that in VNET view screen from <a href="https://portal.azure.com/">https://portal.azure.com/</a>, Subnets tab</li> <li>Edit VNET, set Delegation to None.</li> <li>Delete the VNET from <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a> -&gt; Network -&gt; Manage Existing Networks</li> <li>If you cannot find the VNET in the above step, delete it directly from <a href="https://portal.azure.com/">https://portal.azure.com/</a></li> </ol> <p>If the VNET exists in <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a> but it doesn’t exist in <a href="https://portal.azure.com/">https://portal.azure.com/</a> you should open an ITSM ticket to <code class="language-plaintext highlighter-rouge">public-cloud-framework:global</code></p> <p>Steps to delete a Private DNS Zone:</p> <ol> <li>Identify the Private DNS Zone in <a href="https://portal.azure.com/">https://portal.azure.com/</a></li> <li>Delete all Virtual network links from that Private DNS Zone from <a href="https://portal.azure.com/">https://portal.azure.com/</a> vew screen</li> <li>Delete the Private DNS Zone from <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a> -&gt; DNS -&gt; Manage Private DNS Zones tab</li> <li>If you cannot find the Private DNS Zone in the above step, delete it directly from <a href="https://portal.azure.com/">https://portal.azure.com/</a></li> </ol> <p>If the Private DNS Zone exists in <a href="https://manage.azure.bmw.cloud/">https://manage.azure.bmw.cloud/</a> but it doesn’t exist in <a href="https://portal.azure.com/">https://portal.azure.com/</a> you should open an ITSM ticket to <code class="language-plaintext highlighter-rouge">public-cloud-framework:global</code></p> <p>The remaining resources will be deleted from <a href="https://portal.azure.com/">https://portal.azure.com/</a></p> </div> </div> <div class="search-overlay"></div> </div> <script> var config = { theme: "dark" } ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
