<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/WADTFY/wadtfy-docs/assets/css/just-the-docs-default.css"> <script src="/WADTFY/wadtfy-docs/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script> <script src="/WADTFY/wadtfy-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Kubernetes | WADTFY</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Kubernetes" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="WADTFY Docs" /> <meta property="og:description" content="WADTFY Docs" /> <link rel="canonical" href="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/kubernetes.html" /> <meta property="og:url" content="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/kubernetes.html" /> <meta property="og:site_name" content="WADTFY" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Kubernetes" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"WADTFY Docs","headline":"Kubernetes","url":"https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/kubernetes.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/WADTFY/wadtfy-docs/" class="site-title lh-tight"> WADTFY </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/WADTFY/wadtfy-docs/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Onboarding Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/onboarding-handbook/" class="nav-list-link">Onboarding Handbook</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Cluster Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/cluster-handbook/" class="nav-list-link">Cluster Handbook</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search WADTFY" aria-label="Search WADTFY" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://argocd.api-i.bmwgroup.net" class="site-button" > Int </a> </li> <li class="aux-nav-list-item"> <a href="https://argocd.api.bmwgroup.net" class="site-button" > Prod </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">AppDev Handbook</a></li> <li class="breadcrumb-nav-list-item"><span>Kubernetes</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><strong>Table of Contents</strong></p> <!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> <ul> <li><a href="#kubernetes">Kubernetes</a> <ul> <li><a href="#kubectl"><code class="language-plaintext highlighter-rouge">kubectl</code></a></li> <li><a href="#authenticate-as-service-account">Authenticate as Service Account</a> <ul> <li><a href="#get-service-account-token">Get Service Account Token</a></li> <li><a href="#kubectl-setup"><code class="language-plaintext highlighter-rouge">kubectl</code> Setup</a> <ul> <li><a href="#kubeconfig-optional"><code class="language-plaintext highlighter-rouge">KUBECONFIG</code> (Optional)</a></li> </ul> </li> </ul> </li> <li><a href="#app-configuration">App Configuration</a></li> <li><a href="#deployments">Deployments</a></li> <li><a href="#inspect-containers-and-pods">Inspect Containers and Pods</a> <ul> <li><a href="#remote-shell">Remote Shell</a></li> <li><a href="#port-forwarding">Port-Forwarding</a></li> </ul> </li> <li><a href="#inspect-events">Inspect Events</a></li> <li><a href="#container-runtime-docker">Container Runtime (Docker)</a></li> </ul> </li> </ul> <!-- END doctoc generated TOC please keep comment here to allow auto update --> <h1 id="kubernetes"> <a href="#kubernetes" class="anchor-heading" aria-labelledby="kubernetes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Kubernetes </h1> <p>All your containers run in a <a href="https://kubernetes.io">Kubernetes</a> cluster, maintained by the UNITY team. The following sections describe how you can get limited access to the cluster for various troubleshooting scenarios.</p> <h2 id="kubectl"> <a href="#kubectl" class="anchor-heading" aria-labelledby="kubectl"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">kubectl</code> </h2> <p>To access the Kubernetes cluster, it is recommended to use <a href="https://kubernetes.io/docs/tasks/tools/#kubectl"><code class="language-plaintext highlighter-rouge">kubectl</code></a>. Follow the instructions to install <code class="language-plaintext highlighter-rouge">kubectl</code> for your operating system (Linux, MacOS, Windows).</p> <p>Make sure you can run the following command locally.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div> <p>The steps, to access the Kubernetes cluster are detailed next.</p> <h2 id="authenticate-as-service-account"> <a href="#authenticate-as-service-account" class="anchor-heading" aria-labelledby="authenticate-as-service-account"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authenticate as Service Account </h2> <p>To be able to interact with the cluster’s API server a token plus some additional config is required. In UNITY, for every app there is a service account, which is a technical identify, that can be used to interact with the cluster. The token is securely stored in GitHub Enterprise as repository secret.</p> <h3 id="get-service-account-token"> <a href="#get-service-account-token" class="anchor-heading" aria-labelledby="get-service-account-token"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get Service Account Token </h3> <p>Downloading the token is possible using the <code class="language-plaintext highlighter-rouge">store-secrets</code> workflow in your app’s repository.</p> <p><img src="..%2Fassets%2Fstore-secrets.png" alt="store-secrets.png" /></p> <p>After the action has completed successfully, the <code class="language-plaintext highlighter-rouge">secrets.kdbx</code> file can be downloaded from the <strong>Summary &gt; Artifacts</strong> section. This file can be opened later with the password provided when starting the workflow, and it will contain the secrets from the GitHub repository.</p> <p>🚨 Note that the token may be rolled (new token is generated) by UNITY from time to time. Extracting the service account token is meant for development purposes and must not be used for external service interaction.</p> <p><img src="..%2Fassets%2Fstore-secrets-result.png" alt="store-secrets-result.png" /></p> <h3 id="kubectl-setup"> <a href="#kubectl-setup" class="anchor-heading" aria-labelledby="kubectl-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">kubectl</code> Setup </h3> <p>The <code class="language-plaintext highlighter-rouge">secrets.kdbx</code> contain three environment specific secrets to interact with the Kubernetes cluster. Export all three environment variables in a shell (fill in the actual values from the <code class="language-plaintext highlighter-rouge">secrets.kdbx</code>).</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBERNETES_HOST</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">KUBERNETES_NAMESPACE</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">KUBERNETES_TOKEN</span><span class="o">=</span>...
</code></pre></div></div> <p>Now you can interact with the clusters API server. Validate, by running:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--server</span> <span class="s2">"https://</span><span class="nv">$KUBERNETES_HOST</span><span class="s2">"</span> <span class="nt">--namespace</span> <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span> <span class="nt">--token</span> <span class="s2">"</span><span class="nv">$KUBERNETES_TOKEN</span><span class="s2">"</span> version <span class="nt">--client</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></div> <p>This should output something like:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output=yaml|json to get the full version.
Client Version: version.Info{Major:"1", Minor:"26", GitVersion:"v1.26.1", GitCommit:"8f94681cd294aa8cfd3407b8191f6c70214973a4", GitTreeState:"clean", BuildDate:"2023-01-18T15:51:24Z", GoVersion:"go1.19.5", Compiler:"gc", Platform:"darwin/amd64"}
Kustomize Version: v4.5.7
Server Version: version.Info{Major:"1", Minor:"24", GitVersion:"v1.24.10", GitCommit:"5c1d2d4295f9b4eb12bfbf6429fdf989f2ca8a02", GitTreeState:"clean", BuildDate:"2023-01-27T22:54:20Z", GoVersion:"go1.19.5", Compiler:"gc", Platform:"linux/amd64"}
WARNING: version difference between client (1.26) and server (1.24) exceeds the supported minor version skew of +/-1
</span></code></pre></div></div> <p>The last <code class="language-plaintext highlighter-rouge">WARNIN: Gversion difference between client (1.26) and server (1.24)...</code> indicates that the current version of <code class="language-plaintext highlighter-rouge">kubectl</code> may have some incompatibility with the server API.</p> <p>You can go back and install the <code class="language-plaintext highlighter-rouge">kubectl</code> version that matches the cluster version. However, since the kubectl features that will be used are very basic, it is likely that picking a newer version of <code class="language-plaintext highlighter-rouge">kubectl</code> will not cause any problems.</p> <p>For more information about <code class="language-plaintext highlighter-rouge">kubectl</code> consult the <a href="https://kubernetes.io/docs/reference/kubectl/">official documentation</a>.</p> <h4 id="kubeconfig-optional"> <a href="#kubeconfig-optional" class="anchor-heading" aria-labelledby="kubeconfig-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> (Optional) </h4> <p>As the example call showed, it is possible to pass <code class="language-plaintext highlighter-rouge">KUBERNETES_HOST</code>, <code class="language-plaintext highlighter-rouge">KUBERNETES_NAMESPACE</code>, and <code class="language-plaintext highlighter-rouge">KUBERNETES_TOKEN</code> on every <code class="language-plaintext highlighter-rouge">kubectl</code> invocation. This is a bit cumbersome, thought, when running a lot of <code class="language-plaintext highlighter-rouge">kubectl</code> commands.</p> <p>To make running <code class="language-plaintext highlighter-rouge">kubectl</code> more convenient, set a <code class="language-plaintext highlighter-rouge">kubeconfig</code> up as follows:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export</span> <span class="s2">"KUBECONFIG=~/.kube/config-</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span>
kubectl config set-credentials sa <span class="nt">--token</span> <span class="s2">"</span><span class="nv">$KUBERNETES_TOKEN</span><span class="s2">"</span>
kubectl config set-cluster <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span> <span class="nt">--server</span> <span class="s2">"https://</span><span class="nv">$KUBERNETES_HOST</span><span class="s2">"</span>
kubectl config set-context <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span> <span class="nt">--user</span> sa <span class="nt">--namespace</span> <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span> <span class="nt">--cluster</span> <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span>
kubectl config use-context <span class="s2">"</span><span class="nv">$KUBERNETES_NAMESPACE</span><span class="s2">"</span>
</code></pre></div></div> <p>As long as the <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> environment variable is set, <code class="language-plaintext highlighter-rouge">kubectl</code> can be used without specifying <code class="language-plaintext highlighter-rouge">--server ...</code> on each call.</p> <p>Test the setup by running</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></div> <p>🚨 Note that the token is now stored inside a file (the path <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> points to). To make sure the secret token is not leaked, delete the file after you are done with <code class="language-plaintext highlighter-rouge">kubectl</code> calls.</p> <h2 id="app-configuration"> <a href="#app-configuration" class="anchor-heading" aria-labelledby="app-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> App Configuration </h2> <p>Assuming you have set the <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> you can now inspect the current configuration of your app <code class="language-plaintext highlighter-rouge">app-foo</code> as follows:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secret app-foo <span class="nt">-oyaml</span>
</code></pre></div></div> <p>You can even modify the secret directly using <code class="language-plaintext highlighter-rouge">kubectl edited secret app-foo</code>, but then you should really know what you are doing, as changes will be directly reflected into your apps deployments. A misconfiguration may result in an unwanted downtime.</p> <p>Note that the workflows in your app’s repository make use of the <a href="https://atc-github.azure.cloud.bmw/UNITY/deploy-unity-app">deploy-unity-app</a> action, which uses <code class="language-plaintext highlighter-rouge">kubectl</code> and the service account to sync the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code> into a Kubernetes secret.</p> <p>Additionally, it checks if the image and tag/sha256 combination exists and if they correspond to each other. If sha256 parameter is not present it is added in the kubernetes secret.</p> <h2 id="deployments"> <a href="#deployments" class="anchor-heading" aria-labelledby="deployments"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deployments </h2> <p>Assuming you have set the <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> you can now inspect deployments for your app <code class="language-plaintext highlighter-rouge">app-foo</code> as follows:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get deployment app-foo-api <span class="nt">-oyaml</span>
kubectl get deployment app-foo-ui <span class="nt">-oyaml</span>
</code></pre></div></div> <p>Note that the names of the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployments</a> are concatenated from the app-name <code class="language-plaintext highlighter-rouge">app-test</code> and the deployment names <code class="language-plaintext highlighter-rouge">api</code>, <code class="language-plaintext highlighter-rouge">ui</code> from your <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code>.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">ui</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">api</span><span class="pi">:</span>
  <span class="c1"># ...</span>
</code></pre></div></div> <p>You can also find the names of the deployments on the dashboards in <a href="https://pages.atc-github.azure.cloud.bmw/UNITY/unity/app-dev-handbook/telemetry.html">Grafana</a>.</p> <h2 id="inspect-containers-and-pods"> <a href="#inspect-containers-and-pods" class="anchor-heading" aria-labelledby="inspect-containers-and-pods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Inspect Containers and Pods </h2> <p>Your containers run in <a href="https://kubernetes.io/docs/concepts/workloads/pods/">pods</a>, which is a Kubernetes concept. To interact with a running container, you need to interact with a pod.</p> <p>Currently, it is not possible to find the pod names using <code class="language-plaintext highlighter-rouge">kubectl</code></p> <p>To find the current pod names check the dashboards in <a href="https://pages.atc-github.azure.cloud.bmw/UNITY/unity/app-dev-handbook/telemetry.html">Grafana</a>.</p> <p>For example the resource dashboards show the pod names:</p> <p><img src="../assets/pod-names.png" alt="" /></p> <p>In the example above, the only pod that is currently available in the cluster for interactive inspection is <code class="language-plaintext highlighter-rouge">app-test-api-595459f74c-8vmdk</code>. The other two pods do not run anymore, as can be seen from the chart.</p> <p>When knowing the pod name, various operations can be performed to help troubleshooting</p> <h3 id="remote-shell"> <a href="#remote-shell" class="anchor-heading" aria-labelledby="remote-shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remote Shell </h3> <p>To open a remote shell in a running container follow the example below:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> app-test-api-595459f74c-8vmdk <span class="nt">--</span> sh
</code></pre></div></div> <p>This opens a remote shell (like <code class="language-plaintext highlighter-rouge">ssh</code>) which allows to inspect the internal state of the container. E.g. list files in a temporary directly or show process info of the JVM.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh-4.4<span class="nv">$ </span>jinfo 1
Java System Properties:
<span class="c">#Tue May 30 11:52:15 GMT 2023</span>
java.specification.version<span class="o">=</span>17
<span class="c"># ...</span>

VM Flags:
<span class="nt">-XX</span>:AdaptiveSizePolicyWeight<span class="o">=</span>90 <span class="nt">-XX</span>:CICompilerCount<span class="o">=</span>2 <span class="nt">-XX</span>:+ExitOnOutOfMemoryError <span class="nt">-XX</span>:GCTimeRatio<span class="o">=</span>4 <span class="nt">-XX</span>:InitialHeapSize<span class="o">=</span>33554432 <span class="nt">-XX</span>:MaxHeapFreeRatio<span class="o">=</span>20 <span class="nt">-XX</span>:MaxHeapSize<span class="o">=</span>134217728 <span class="nt">-XX</span>:MaxNewSize<span class="o">=</span>44564480 <span class="nt">-XX</span>:MinHeapDeltaBytes<span class="o">=</span>524288 <span class="nt">-XX</span>:MinHeapFreeRatio<span class="o">=</span>10 <span class="nt">-XX</span>:MinHeapSize<span class="o">=</span>33554432 <span class="nt">-XX</span>:NewSize<span class="o">=</span>11010048 <span class="nt">-XX</span>:NonNMethodCodeHeapSize<span class="o">=</span>5826188 <span class="nt">-XX</span>:NonProfiledCodeHeapSize<span class="o">=</span>122916026 <span class="nt">-XX</span>:OldSize<span class="o">=</span>22544384 <span class="nt">-XX</span>:ProfiledCodeHeapSize<span class="o">=</span>122916026 <span class="nt">-XX</span>:ReservedCodeCacheSize<span class="o">=</span>251658240 <span class="nt">-XX</span>:+SegmentedCodeCache <span class="nt">-XX</span>:SoftMaxHeapSize<span class="o">=</span>134217728 <span class="nt">-XX</span>:+UseCompressedClassPointers <span class="nt">-XX</span>:+UseCompressedOops <span class="nt">-XX</span>:+UseParallelGC

VM Arguments:
jvm_args: <span class="nt">-Dquarkus</span>.http.host<span class="o">=</span>0.0.0.0 <span class="nt">-Djava</span>.util.logging.manager<span class="o">=</span>org.jboss.logmanager.LogManager <span class="nt">-Xms32m</span> <span class="nt">-Xmx128m</span> <span class="nt">-XX</span>:+UseParallelGC <span class="nt">-XX</span>:MinHeapFreeRatio<span class="o">=</span>10 <span class="nt">-XX</span>:MaxHeapFreeRatio<span class="o">=</span>20 <span class="nt">-XX</span>:GCTimeRatio<span class="o">=</span>4 <span class="nt">-XX</span>:AdaptiveSizePolicyWeight<span class="o">=</span>90 <span class="nt">-XX</span>:+ExitOnOutOfMemoryError
java_command: /deployments/quarkus-run.jar
java_class_path <span class="o">(</span>initial<span class="o">)</span>: /deployments/quarkus-run.jar
Launcher Type: SUN_STANDARD
</code></pre></div></div> <p>🚨 You can even modify files and configuration, but keep in mind that all changes will be lost after the next pod is started. This is for troubleshooting and experiments only.</p> <h3 id="port-forwarding"> <a href="#port-forwarding" class="anchor-heading" aria-labelledby="port-forwarding"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Port-Forwarding </h3> <p>To <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/">forward a port</a> from a pod to your local machine you can map ports as shown below:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward app-foo-api-5c484fd67c-9x9ll 8080:8080
</code></pre></div></div> <p>If your app exposes that port to serve http requests, you should be able to open e.g. the Swagger UI page locally over the mapped port by opening <a href="http://localhost:8080/test/api/swagger-ui">http://localhost:8080/test/api/swagger-ui</a> (after adjusting the URL).</p> <h2 id="inspect-events"> <a href="#inspect-events" class="anchor-heading" aria-labelledby="inspect-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Inspect Events </h2> <p>Sometimes it is useful to inspect the <a href="https://kubernetes.io/docs/reference/kubernetes-api/cluster-resources/event-v1/">events</a> from the Kubernetes cluster. The application service account token is authorized to list the events from the cluster:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get events
</code></pre></div></div> <h2 id="container-runtime-docker"> <a href="#container-runtime-docker" class="anchor-heading" aria-labelledby="container-runtime-docker"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Container Runtime (Docker) </h2> <p>At the core of the Kubernetes cluster is a container runtime. Each Kubernetes cluster may have a different container runtime and configuration at its heart. Most settings are security related, and sometimes it can be hard to troubleshoot why a specific container is not running as intended. Here are a few guidelines on preparing and testing containers to run in UNITY:</p> <ul> <li>containers must not require privileged users to run e.g. root user and sudo commands will not work) Reference: <a href="https://kubesec.io/basics/containers-securitycontext-runasnonroot-true/">Force the running image to run as a non-root user to ensure least privilege</a></li> <li>containers should run as user 10000 in group 10000 See <a href="https://gggauravgandhi.medium.com/uid-user-identifier-and-gid-group-identifier-in-linux-121ea68bf510">UID (User Identifier) and GID (Group Identifier) in Linux</a> for a quick explanation. A specific user, with uid &gt; 10000, to run the container may be specified via <code class="language-plaintext highlighter-rouge">runAsUser</code> in the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code>. Reference: <a href="https://kubesec.io/basics/containers-securitycontext-runasuser/">Run as a high-UID user to avoid conflicts with the host’s user table</a></li> <li>By default, all capabilities are dropped. See <a href="https://earthly.dev/blog/intro-to-linux-capabilities">An Introduction to Linux Capabilities</a> for a quick overview. Specific capabilities, such as <code class="language-plaintext highlighter-rouge">NET_BIND_SERVICE</code> may be added via the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code>. Reference: <a href="https://kubesec.io/basics/containers-securitycontext-capabilities-drop-index-all/">Drop all capabilities and add only those required to reduce syscall attack surface</a></li> <li>The root filesystem of a container will be readonly. Temporary directories that the container requires write permission to should be specified as <code class="language-plaintext highlighter-rouge">tmpDirs</code> in the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code>. Reference: <a href="https://kubesec.io/basics/containers-securitycontext-readonlyrootfilesystem-true/">An immutable root filesystem can prevent malicious binaries being added to PATH and increase attack cost</a></li> </ul> <p>To test a container locally, the following docker command gets quite close to the specifications above:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--read-only</span> <span class="nt">--cap-drop</span> ALL <span class="nt">--user</span> 10000:10000 my-image
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> <script> var config = { theme: "dark" } ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
