<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/WADTFY/wadtfy-docs/assets/css/just-the-docs-default.css"> <script src="/WADTFY/wadtfy-docs/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script> <script src="/WADTFY/wadtfy-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>PostgreSQL Flexible Server | WADTFY</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="PostgreSQL Flexible Server" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="WADTFY Docs" /> <meta property="og:description" content="WADTFY Docs" /> <link rel="canonical" href="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/postgresql-flexible-server.html" /> <meta property="og:url" content="https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/postgresql-flexible-server.html" /> <meta property="og:site_name" content="WADTFY" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="PostgreSQL Flexible Server" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"WADTFY Docs","headline":"PostgreSQL Flexible Server","url":"https://pages.atc-github.azure.cloud.bmw/WADTFY/wadtfy-docs//WADTFY/wadtfy-docs/onboarding-handbook/postgresql-flexible-server.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/WADTFY/wadtfy-docs/" class="site-title lh-tight"> WADTFY </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/WADTFY/wadtfy-docs/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Onboarding Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/onboarding-handbook/" class="nav-list-link">Onboarding Handbook</a><ul class="nav-list "><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/onboarding-handbook/app-configuration.html" class="nav-list-link">App Configuration</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Cluster Handbook category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/WADTFY/wadtfy-docs/cluster-handbook/" class="nav-list-link">Cluster Handbook</a><ul class="nav-list "><li class="nav-list-item "><a href="/WADTFY/wadtfy-docs/cluster-handbook/accesses.html" class="nav-list-link">Accesses</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search WADTFY" aria-label="Search WADTFY" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://argocd.api-i.bmwgroup.net" class="site-button" > Int </a> </li> <li class="aux-nav-list-item"> <a href="https://argocd.api.bmwgroup.net" class="site-button" > Prod </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">AppDev Handbook</a></li> <li class="breadcrumb-nav-list-item"><span>PostgreSQL Flexible Server</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><strong>Table of Contents</strong></p> <!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> <ul> <li><a href="#postgresql-flexible-server-pilot-phase">PostgreSQL Flexible Server (Pilot Phase)</a> <ul> <li><a href="#features">Features</a></li> <li><a href="#limitations">Limitations</a></li> <li><a href="#provision-new-database-server">Provision New Database Server</a> <ul> <li><a href="#connect-from-local-machine">Connect From Local Machine</a></li> <li><a href="#create-user-and-database">Create User and Database</a></li> <li><a href="#setup-quarkus">Setup Quarkus</a></li> </ul> </li> <li><a href="#change-administrator-password">Change Administrator Password</a></li> <li><a href="#change-stock-keeping-unit-sku">Change Stock Keeping Unit (SKU)</a></li> <li><a href="#migrate-from-a-postgresql-outside-of-unity">Migrate From a PostgreSQL Outside of UNITY</a></li> <li><a href="#replication">Replication</a> <ul> <li><a href="#promote-replica">Promote Replica</a></li> </ul> </li> <li><a href="#point-in-time-restore-pitr">Point in Time Restore (PITR)</a></li> <li><a href="#upgrade-major-postgresql-version">Upgrade Major PostgreSQL Version</a> <ul> <li><a href="#upgrade-dry-run">Upgrade Dry-Run</a></li> <li><a href="#upgrade-with-server-switch">Upgrade With Server Switch</a></li> <li><a href="#in-place-upgrade">In-Place Upgrade</a></li> </ul> </li> <li><a href="#disaster-recovery">Disaster Recovery</a></li> </ul> </li> </ul> <!-- END doctoc generated TOC please keep comment here to allow auto update --> <h1 id="postgresql-flexible-server-pilot-phase"> <a href="#postgresql-flexible-server-pilot-phase" class="anchor-heading" aria-labelledby="postgresql-flexible-server-pilot-phase"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PostgreSQL Flexible Server (Pilot Phase) </h1> <p><a href="https://learn.microsoft.com/en-en/azure/postgresql/flexible-server/">PostgreSQL Flexible Server</a> is an Azure Service to run a PostgreSQL server with one or multiple databases.</p> <p>UNITY offers simplified provisioning through the <code class="language-plaintext highlighter-rouge">unity-app.*.yaml</code>. Make sure to understand the implications of configuration changes, as they may result in unwanted data loss.</p> <p>⚠️ The solution is currently in piloting phase and may be tested on the integration environment. It is not sufficiently tested for production workloads yet. The UNITY team is looking forward to your feedback.</p> <h2 id="features"> <a href="#features" class="anchor-heading" aria-labelledby="features"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Features </h2> <ul> <li> <p><strong>Customer Managed Keys</strong></p> <p>Every database is provisioned with a <a href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-data-encryption">Customer Manged Key</a>, which is automatically rotated every 30 days.</p> </li> <li> <p><strong>User assigned managed identity</strong></p> <p>Every database has a <a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">user assigned managed identity</a>.</p> </li> <li> <p><strong>Point In Time Restore</strong></p> <p>Database servers can be restored to any point in time up to 35 days in the past. Note that only an entire database server can be restored to a specific point in time. If there are multiple databases on one server, there is no way to restore only a single database.</p> </li> <li> <p><strong>Major Version Migration</strong></p> <p>Automatic major version upgrades are supported. You are responsible for executing and testing the upgrades. Note that downgrading a major version is not possible.</p> </li> <li> <p><strong>Stock Keeping Units (SKUs)</strong></p> <p>Azure provides a broad range of <a href="https://learn.microsoft.com/en-us/partner-center/developer/product-resources#sku">SKUs</a>. You are responsible for choosing the smallest SKU possible fulfilling your requirement, to keep costs for infrastructure at a minimum. By default, the smallest possible SKU will be picked, which should be sufficient to get started on an integration environment.</p> </li> <li> <p><strong>Network Integration</strong></p> <p>You database server will run in a dedicated VNET on Azure. This VNET is integrated into the BMW intranet following the <a href="https://atc.bmwgroup.net/confluence/x/d7pBKQ">Azure Network Design</a>. In essence, the DB will be accessible from any BMW client with a <code class="language-plaintext highlighter-rouge">10.0.0.0/8</code> IP. As well as any Azure VNET, such as the one where your application runs.</p> </li> </ul> <h2 id="limitations"> <a href="#limitations" class="anchor-heading" aria-labelledby="limitations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Limitations </h2> <ul> <li> <p><strong>No High Availability</strong></p> <p>High availability is currently disabled by default. This may change in the future. Read more about it in Azure’s <a href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-high-availability">High Availability Concept</a>.</p> </li> <li> <p><strong>Maintenance Windows</strong></p> <p>PostgreSQL Flexible Servers are security patched automatically during maintenance windows. This can lead to short downtimes. By default, the maintenance window is configured to start Sundays, 00:00 UTC with a duration of one hour. Read more about it in Azure’s <a href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-maintenance">Maintenance Concept</a>. Maintenance windows are currently selected by UNITY for you, if you need more ingrained control, please request a new feature by contacting the UNITY team.</p> </li> <li> <p><strong>No Geo Redundant Backup</strong></p> <p>Geo redundant backup is currently disabled by default. This may change in the future. Read more about it in Azure’s <a href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-backup-restore#geo-redundant-backup-and-restore">Geo Redundant Backup and Restore Concept</a>.</p> </li> <li> <p><strong>No Network Peering</strong></p> <p>Network peering with the VNET of the Kubernetes cluster for low latency connections is currently not possible, due to limitations on <a href="https://developer.bmw.com/docs/4wheels-managed/">4Wheels Managed</a> side. From our <a href="https://atc.bmwgroup.net/jira/browse/UNITYAPPS-617">tests</a> you can expect a latency around 4ms and a throughput of &gt; 270 transactions per seconds.</p> </li> </ul> <h2 id="provision-new-database-server"> <a href="#provision-new-database-server" class="anchor-heading" aria-labelledby="provision-new-database-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Provision New Database Server </h2> <p>You can provision one or multiple database servers for your UNITY app as described below.</p> <p>The best way to provision a new database server is to start with encrypting your administrator password. This can be done in the same way as described in <a href="app-configuration.html#secrets">encrypting secret environment variables</a>.</p> <p>When running the encrypt workflow, your yaml path for a Db server named <code class="language-plaintext highlighter-rouge">db-v14</code> would be: <code class="language-plaintext highlighter-rouge">postgresqlFlexibleServers.db-v14.administratorPassword</code></p> <p><img src="../assets/posgresql-encrypt.png" alt="posgresql-encrypt.png" /></p> <p>This workflow will create a new branch with your encrypted password. You can check out the branch and extend the config to look like the one below:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
</code></pre></div></div> <p>After merging this config to the main branch and rolling it out to UNITY, the database server will be provisioned.</p> <p>This config will create one database server <code class="language-plaintext highlighter-rouge">db-v14</code>. More advanced configuration is possible with details documented in the <a href="unity-app-yaml.html">unity-app-yaml schema</a> and in the sections below.</p> <h3 id="connect-from-local-machine"> <a href="#connect-from-local-machine" class="anchor-heading" aria-labelledby="connect-from-local-machine"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Connect From Local Machine </h3> <p>🚨 Spinning up your database can take up to 30 min, so be patient before creating an incident when something does not seam to be working after a few minutes. So far, there is no way to get notified when your database is available, this might be added in the future.</p> <p>The connection will be possible with the following parameters with <a href="https://www.postgresql.org/docs/current/app-psql.html"><code class="language-plaintext highlighter-rouge">psql</code></a>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PGHOST</span><span class="o">=</span><span class="s1">'{your app repo name}-pfs-{your db server name}.postgres.database.azure.com'</span>
<span class="nb">export </span><span class="nv">PGUSER</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPORT</span><span class="o">=</span>5432
<span class="nb">export </span><span class="nv">PGDATABASE</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="s1">'{your-password}'</span>
psql
</code></pre></div></div> <p>So for example, when your app is called <code class="language-plaintext highlighter-rouge">foo</code>, your DB server is called <code class="language-plaintext highlighter-rouge">db-v14</code>, and the password <code class="language-plaintext highlighter-rouge">change-me</code>, then the upper variables will look like:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PGHOST</span><span class="o">=</span><span class="s1">'app-foo-pfs-db-v14.postgres.database.azure.com'</span>
<span class="nb">export </span><span class="nv">PGUSER</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPORT</span><span class="o">=</span>5432
<span class="nb">export </span><span class="nv">PGDATABASE</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="s1">'change-me'</span>
psql
</code></pre></div></div> <h3 id="create-user-and-database"> <a href="#create-user-and-database" class="anchor-heading" aria-labelledby="create-user-and-database"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create User and Database </h3> <p>To enhance the security of your database, it is discouraged to use the administrator user for all tasks. Instead, it is advisable to set up a dedicated user with minimal permissions. Follow these steps after connecting as an administrator to <a href="https://www.postgresql.org/docs/current/sql-createuser.html">create a new user</a> for your app, ensuring to choose a secure password, and then proceed to create a new database.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="nb">int</span> <span class="k">ENCODING</span> <span class="s1">'utf-8'</span> <span class="n">LOCALE</span> <span class="s1">'en_US.utf8'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="n">api</span> <span class="k">WITH</span> <span class="k">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s1">'change-me'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="nb">int</span> <span class="k">TO</span> <span class="n">api</span><span class="p">;</span>
</code></pre></div></div> <p>It is essential to restrict the <a href="https://www.postgresql.org/docs/current/sql-grant.html">privileges</a> of each user to only the actions they require. For improved security, consider having separate users with different sets of permissions: one for creating the schema and others for read and write operations.</p> <p>Remember that it is best practice to maintain only one database per server, as <a href="#point-in-time-restore-pitr">PITR</a> will be available for the entire server and not for individual databases. This approach ensures a more streamlined and efficient database management process.</p> <h3 id="setup-quarkus"> <a href="#setup-quarkus" class="anchor-heading" aria-labelledby="setup-quarkus"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setup Quarkus </h3> <p>Quarkus can be set up in various ways to connect to a PostgreSQL database. Recommended articles on the topic are</p> <ul> <li><a href="https://quarkus.io/guides/datasource">Configure Data Sources in Quarkus</a></li> <li><a href="https://quarkus.io/guides/reactive-sql-clients">Reactive SQL Clients</a></li> <li><a href="https://quarkus.io/guides/flyway">Using Flyway</a></li> <li><a href="https://quarkus.io/guides/hibernate-orm">Using Hibernate Orm and Jakarta Persistence</a></li> <li><a href="https://quarkus.io/guides/hibernate-orm-panache">Simplified Hibernate Orm With Panache</a></li> </ul> <p>The guideline below will demonstrate a minimal setup using Hibernate and Panache to implement a simple REST resource.</p> <p>Add all relevant quarkus extensions</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn quarkus:add-extension <span class="nt">-Dextensions</span><span class="o">=</span><span class="s2">"jdbc-postgresql,quarkus-hibernate-orm-panache,quarkus-flyway,resteasy-reactive-jackson"</span>
</code></pre></div></div> <p>Configure the database connection as environment variables on the Quarkus deployment to connect to the database from a deployed app:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="c1"># ...</span>
    <span class="na">container</span><span class="pi">:</span>
      <span class="c1"># ...</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">QUARKUS_DATASOURCE_DB_KIND</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">postgresql</span>
        <span class="na">QUARKUS_DATASOURCE_DB_VERSION</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">14"</span>
        <span class="na">QUARKUS_DATASOURCE_USERNAME</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">api</span>
        <span class="na">QUARKUS_DATASOURCE_JDBC_URL</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">jdbc:postgresql://app-foo-pfs-db-v14.postgres.database.azure.com:5432/int</span>
      <span class="na">secretEnv</span><span class="pi">:</span>
        <span class="na">QUARKUS_DATASOURCE_PASSWORD</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJK0JT36cz7u7M=]</span>
</code></pre></div></div> <p>Note that <code class="language-plaintext highlighter-rouge">QUARKUS_DATASOURCE_PASSWORD</code> should contain the <a href="app-configuration.html#secrets">encrypted value</a> of the user’s password.</p> <p>Here are a few notes on the most important config options:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">quarkus.hibernate-orm.second-level-caching-enabled</code> is recommended to be set to <code class="language-plaintext highlighter-rouge">false</code> in the <code class="language-plaintext highlighter-rouge">application.properties</code> for a stateless multi replica deployment, to avoid inconsistent cache state between replicas, read <a href="https://www.baeldung.com/hibernate-second-level-cache#Cache">Hibernate Second-Level Cache</a> for details.</p> <p>🚨 this is a build time config, which cannot be set in the deployment’s env variables.</p> </li> <li> <p><a href="https://quarkus.io/guides/all-config#quarkus-agroal_quarkus.datasource.jdbc.acquisition-timeout"><code class="language-plaintext highlighter-rouge">QUARKUS_DATASOURCE_JDBC_ACQUISITION_TIMEOUT</code></a> can require some adjustments when you find <code class="language-plaintext highlighter-rouge">Acquisition timeout while waiting for new connection</code> errors on startup in the logs. This is an indication that setting up the connection to the database takes too long. One way is to increase <code class="language-plaintext highlighter-rouge">QUARKUS_DATASOURCE_JDBC_ACQUISITION_TIMEOUT</code> to e.g. <code class="language-plaintext highlighter-rouge">10</code> seconds. It is strongly recommended, though, to check the CPU requests and limits, as this timeout can be an indication for too few resources, which is why Quarkus is running into the timeout.</p> </li> <li> <p>Set <code class="language-plaintext highlighter-rouge">QUARKUS_LOG_CATEGORY__ORG_POSTGRESQL__MIN_LEVEL</code> and <code class="language-plaintext highlighter-rouge">QUARKUS_LOG_CATEGORY__ORG_POSTGRESQL__LEVEL</code> to <code class="language-plaintext highlighter-rouge">TRACE</code> to troubleshoot connection problems.</p> </li> <li> <p>Set <code class="language-plaintext highlighter-rouge">QUARKUS_LOG_CATEGORY__ORG_FLYWAYDB__MIN_LEVEL</code> and <code class="language-plaintext highlighter-rouge">QUARKUS_LOG_CATEGORY__ORG_FLYWAYDB__LEVEL</code> to <code class="language-plaintext highlighter-rouge">TRACE</code> to troubleshoot problems with flyway.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">quarkus.hibernate-orm.metrics.enabled</code> is recommended to be set to <code class="language-plaintext highlighter-rouge">true</code> in the <code class="language-plaintext highlighter-rouge">application.properties</code> to expose metrics to Prometheus.</p> <p>🚨 this is a build time config, which cannot be set in the deployment’s env variables.</p> </li> <li> <p>Set <code class="language-plaintext highlighter-rouge">QUARKUS_HIBERNATE_ORM_LOG_SESSION_METRICS</code> to <code class="language-plaintext highlighter-rouge">true</code> to see metrics on Hibernate sessions in the logs. This requires <code class="language-plaintext highlighter-rouge">quarkus.hibernate-orm.metrics.enabled</code> to be <code class="language-plaintext highlighter-rouge">true</code>.</p> </li> </ul> <p>To test the connection locally, you can set the same environment variables in your IDE or use the <code class="language-plaintext highlighter-rouge">dev</code> profile in the application properties.</p> <p>⚠️ Make sure to never commit the content of <code class="language-plaintext highlighter-rouge">QUARKUS_DATASOURCE_PASSWORD</code> in a run configuration or properties file.</p> <p>For managing the schema, it is recommended to use <a href="https://quarkus.io/guides/flyway">flyway</a>. It is beyond the scope of this documentation to give detailed instructions on <a href="https://flywaydb.org">flyway</a>.</p> <p>A minimal setup is to add the following <code class="language-plaintext highlighter-rouge">application.properties</code></p> <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">quarkus.flyway.migrate-at-start</span><span class="p">=</span><span class="s">true</span>
</code></pre></div></div> <p>⚠️ When implementing long-running schema migrations, there is the risk that the pod gets killed during startup, before completing the migration due to failing health checks. When long-running schema migrations are required, consider running them from a GitHub workflow or adjust health checks accordingly.</p> <p>Create the schema from the following file <code class="language-plaintext highlighter-rouge">api/src/main/resources/db/migration/V1__baseline.sql</code></p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dev_model_range</span> <span class="p">(</span> <span class="n">id</span>   <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">code</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dev_model_range</span> <span class="k">values</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'G30'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dev_model_range</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'G60'</span><span class="p">);</span>
</code></pre></div></div> <p>Implement a minimal resource and entity:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.quarkus.hibernate.orm.panache.PanacheEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.persistence.Entity</span><span class="o">;</span>

<span class="nd">@Entity</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"dev_model_range"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevModelRange</span> <span class="kd">extends</span> <span class="nc">PanacheEntity</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="n">code</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DevModelRange</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">jakarta.ws.rs.GET</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.ws.rs.Path</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Path</span><span class="o">(</span><span class="s">"/v1/dev-model-ranges"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevModelRangeResource</span> <span class="o">{</span>

    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DevModelRange</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DevModelRange</span><span class="o">.</span><span class="na">listAll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>This should allow to fetch the entities from the following REST resource locally:</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET http://localhost:8080/foo/api/v1/dev-model-ranges/
</span></code></pre></div></div> <p>Which should result in the following JSON response:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"G30"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"G60"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <h2 id="change-administrator-password"> <a href="#change-administrator-password" class="anchor-heading" aria-labelledby="change-administrator-password"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Change Administrator Password </h2> <p>The password for the administrator is provided by you in encrypted form, when requesting a new DB server. password encryption follows the same steps as for <a href="app-configuration.html#secrets">encrypting secret environment variables</a>.</p> <p>You can update the password any time, and you are fully responsible for maintaining a secure password and rotating it in compliance with current <a href="https://atc.bmwgroup.net/confluence/x/Aut7CQ">work instructions</a>.</p> <h2 id="change-stock-keeping-unit-sku"> <a href="#change-stock-keeping-unit-sku" class="anchor-heading" aria-labelledby="change-stock-keeping-unit-sku"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Change Stock Keeping Unit (SKU) </h2> <p>You are responsible for choosing the smallest <a href="https://learn.microsoft.com/en-us/partner-center/developer/product-resources#sku">SKU</a> possible fulfilling your requirement, to keep costs for infrastructure at a minimum. By default, the smallest possible burstable SKU will be picked.</p> <p>In some cases (e.g. <a href="#replication">replication</a>) it is required to switch to a non-burstable SKU (e.g. <code class="language-plaintext highlighter-rouge">GP_Standard_D2ds_v4</code>) as shown below.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">sku</span><span class="pi">:</span> <span class="s">GP_Standard_D2ds_v4</span>
    <span class="c1"># ...</span>
</code></pre></div></div> <p>The SKU can be changed at any time and does not result in data loss. While caning the SKU the database will not be available.</p> <h2 id="migrate-from-a-postgresql-outside-of-unity"> <a href="#migrate-from-a-postgresql-outside-of-unity" class="anchor-heading" aria-labelledby="migrate-from-a-postgresql-outside-of-unity"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Migrate From a PostgreSQL Outside of UNITY </h2> <p>You should create a dump using <a href="https://www.postgresql.org/docs/current/app-pgdump.html"><code class="language-plaintext highlighter-rouge">pg_dump</code></a> from your original database and restore it into the new database using <a href="https://www.postgresql.org/docs/current/app-pgrestore.html"><code class="language-plaintext highlighter-rouge">pg_restore</code></a>. Detailed instructions is currently beyond the scope of this documentation.</p> <h2 id="replication"> <a href="#replication" class="anchor-heading" aria-labelledby="replication"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Replication </h2> <blockquote> <p>The read replica feature allows you to replicate data from an Azure Database for PostgreSQL server to a read-only replica. Replicas are updated asynchronously with the PostgreSQL engine native physical replication technology.</p> </blockquote> <p>see <a href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-read-replicas">Read replicas in Azure Database for PostgreSQL</a>.</p> <p>A read replica can be set up for any database server.</p> <p>Before a read replica can be set up, the source database server as well as the read replica server must be configured to have a non-burstable SKU. Here is a complete example:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">sku</span><span class="pi">:</span> <span class="s">GP_Standard_D2ds_v4</span>
  <span class="na">db-v14-replica</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Replica</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v14</span>
    <span class="na">sku</span><span class="pi">:</span> <span class="s">GP_Standard_D2ds_v4</span>
</code></pre></div></div> <h3 id="promote-replica"> <a href="#promote-replica" class="anchor-heading" aria-labelledby="promote-replica"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Promote Replica </h3> <p>Disconnecting a read replica from its source is called promoting. After promoting a replica it will be a standalone database server which cannot be connected to its source server later on at any point in time.</p> <p>To promote the replica from the example above, add the <code class="language-plaintext highlighter-rouge">replicationRole: None</code>.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">sku</span><span class="pi">:</span> <span class="s">GP_Standard_D2ds_v4</span>
  <span class="na">db-v14-replica</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Replica</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v14</span>
    <span class="na">replicationRole</span><span class="pi">:</span> <span class="s">None</span>
    <span class="na">sku</span><span class="pi">:</span> <span class="s">GP_Standard_D2ds_v4</span>
</code></pre></div></div> <p>🚨 Note, when a database server was created as replica, you need to keep the <code class="language-plaintext highlighter-rouge">sourceServerName</code> and <code class="language-plaintext highlighter-rouge">replicationRole</code> role in the config, even if you upgrade the promoted replica to a newer version as shown below.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
  <span class="na">db-v14-replica</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">15</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Update</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v14</span>
    <span class="na">replicationRole</span><span class="pi">:</span> <span class="s">None</span>
</code></pre></div></div> <p>Note that upgrading a server in replication mode (i.e. <code class="language-plaintext highlighter-rouge">replicationRole: null</code> is currently unsupported).</p> <h2 id="point-in-time-restore-pitr"> <a href="#point-in-time-restore-pitr" class="anchor-heading" aria-labelledby="point-in-time-restore-pitr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Point in Time Restore (PITR) </h2> <p>⚠️ <strong>DOWNTIME:</strong> while restoring, make sure the original database does not receive any writes. All changes after the restore point will be lost.</p> <p>PITR is the standard way to restore corrupted data. You can restore the state of the entire database server to any point up to 35 days in the past.</p> <p>PITR will always result in a new database server! So the original server will always stat as is. After restoring a database you can destroy the original database if not needed anymore.</p> <p>Here is a step-by-step procedure to recover from corrupted data:</p> <ol> <li>Decide if you need to shut down your app. To avoid keep writing to the original database which should be replaced, it might be the best approach to shut down your application while restoring your database. To do so, you can set all replicas to 0. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">ui</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># ...</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> <p>Alternatively, you can also set your application to a read only mode, if you have prepared your application for this scenario.</p> </li> <li>Restore your database server by adding another database server with mode <code class="language-plaintext highlighter-rouge">PointInTimeRestore</code>. You need to keep your original database server until you have restored into you new database server. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
  <span class="na">db-v14-pitr</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">PointInTimeRestore</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v14</span>
    <span class="na">pointInTimeRestoreUTC</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2023-07-21T08:55:00Z"</span>
</code></pre></div> </div> <p>🚨 the destination server must have the same major version as the source server. 🚨 Note that <code class="language-plaintext highlighter-rouge">sourceServerName</code> and <code class="language-plaintext highlighter-rouge">pointInTimeRestoreUTC</code> restore must be kept in the config, even if a version upgrade is done or if the source server is deleted.</p> </li> <li>Verify new DB is up and running. As soon as the recovery process completed, you should verify that it is up and running. Try connecting to your new DB with e.g. <a href="https://www.postgresql.org/docs/current/app-psql.html"><code class="language-plaintext highlighter-rouge">psql</code></a>. <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PGHOST</span><span class="o">=</span>app-foo-pfs-db-v14-pitr.postgres.database.azure.com
<span class="nb">export </span><span class="nv">PGPORT</span><span class="o">=</span>5432
<span class="nb">export </span><span class="nv">PGDATABASE</span><span class="o">=</span>int
<span class="nb">export </span><span class="nv">PGUSER</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="s2">"{your-password}"</span>
pslq
</code></pre></div> </div> </li> <li>Switch your app to the new database (and scale it up again) To do so, change the connection URL of your app to the new URL and scale up replicas. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">ui</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="c1"># ...</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">env</span><span class="pi">:</span>
     <span class="na">QUARKUS_DATASOURCE_JDBC_URL</span><span class="pi">:</span>
       <span class="na">value</span><span class="pi">:</span> <span class="s">jdbc:postgresql://app-foo-pfs-db-v14-pitr.postgres.database.azure.com:5432/int</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> </ol> <h2 id="upgrade-major-postgresql-version"> <a href="#upgrade-major-postgresql-version" class="anchor-heading" aria-labelledby="upgrade-major-postgresql-version"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Upgrade Major PostgreSQL Version </h2> <p>You can migrate from one major version to the next one in an automated way.</p> <p>⚠️ Note, once a database was upgraded to the next major version, it cannot be downgraded again.</p> <p>There are several protocols you can follow, outlined in the sections below.</p> <h3 id="upgrade-dry-run"> <a href="#upgrade-dry-run" class="anchor-heading" aria-labelledby="upgrade-dry-run"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Upgrade Dry-Run </h3> <p>It is strongly recommended to test major version migration on a PITR server before doing the actual migration. While testing the upgrade, your app is not affected and no downtime will occur.</p> <p>The basic idea is to create a <a href="#point-in-time-restore-pitr">PITR</a> server of a recent timestamp. Instead of switching your app to the restored server, you keep it running on the original DB. The restored replica can be used to test the migration.</p> <p>In detail, follow the steps below:</p> <ol> <li>Create a PITR replica without changing the version <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v13</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">PointInTimeRestore</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v13</span>
    <span class="na">pointInTimeRestoreUTC</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2023-07-21T08:55:00Z"</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> <li>Migrate the replica to the new version by removing the <code class="language-plaintext highlighter-rouge">pointInTimeRestoreUTC</code> and <code class="language-plaintext highlighter-rouge">sourceServerName</code> and changing the mode to <code class="language-plaintext highlighter-rouge">Update</code>. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v13</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Update</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> <li>Verify that your new DB is working as expected.</li> <li>Complete the test by cleaning up the test replica. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v13</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> </ol> <h3 id="upgrade-with-server-switch"> <a href="#upgrade-with-server-switch" class="anchor-heading" aria-labelledby="upgrade-with-server-switch"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Upgrade With Server Switch </h3> <p>⚠️ <strong>DOWNTIME:</strong> while upgrading, make sure the original database does not receive any writes. All changes after the restore point will be lost.</p> <p>This protocol follows the dry run outlined below, but combines it with a PITR.</p> <ol> <li>Decide if you need to shut down your app. To avoid keep writing to the original database which should be replaced, it might be the best approach to shut down your application while restoring your database. To do so, you can set all replicas to 0. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">ui</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># ...</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> <p>Alternatively, you can also set your application to a read only mode, if you have prepared your application for this scenario.</p> </li> <li>Restore your database server by adding another database server with mode <code class="language-plaintext highlighter-rouge">PointInTimeRestore</code> without changing the version. You need to keep your original database server until you have restored into you new database server. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v13</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">administratorPassword</span><span class="pi">:</span> <span class="s">crypt.v1[7kQJslSOT7dQs6XlN/R4Mma27LS/gwJKJ0T63cz7u7M=]</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">PointInTimeRestore</span>
    <span class="na">sourceServerName</span><span class="pi">:</span> <span class="s">db-v13</span>
    <span class="na">pointInTimeRestoreUTC</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2023-07-21T08:55:00Z"</span>
</code></pre></div> </div> </li> <li>Verify new DB is up and running. As soon as the recovery process completed, you should verify that it is up and running. Try connecting to your new DB with e.g. psql. <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PGHOST</span><span class="o">=</span>app-foo-pfs-db-v14.postgres.database.azure.com
<span class="nb">export </span><span class="nv">PGPORT</span><span class="o">=</span>5432
<span class="nb">export </span><span class="nv">PGDATABASE</span><span class="o">=</span>int
<span class="nb">export </span><span class="nv">PGUSER</span><span class="o">=</span>postgres
<span class="nb">export </span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="s2">"{your-password}"</span>
pslq
</code></pre></div> </div> </li> <li>Migrate the replica to the new version by removing the <code class="language-plaintext highlighter-rouge">pointInTimeRestoreUTC</code> and <code class="language-plaintext highlighter-rouge">sourceServerName</code> and changing the mode to <code class="language-plaintext highlighter-rouge">Update</code>. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db-v13</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Update</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> <li>Verify the upgrade succeeded.</li> <li>Switch your app to the new database (and scale it up again) To do so, change the connection URL of your app to the new URL and scale up replicas. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deployments</span><span class="pi">:</span>
  <span class="na">ui</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="c1"># ...</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">env</span><span class="pi">:</span>
     <span class="na">QUARKUS_DATASOURCE_JDBC_URL</span><span class="pi">:</span>
       <span class="na">value</span><span class="pi">:</span> <span class="s">jdbc:postgresql://app-foo-pfs-db-v14.postgres.database.azure.com:5432/int</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> <li>Clean up the old database. <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="c1"># ... db-v13 removed</span>
  <span class="na">db-v14</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
</code></pre></div> </div> </li> </ol> <h3 id="in-place-upgrade"> <a href="#in-place-upgrade" class="anchor-heading" aria-labelledby="in-place-upgrade"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> In-Place Upgrade </h3> <p>⚠️ <strong>DOWNTIME:</strong> the database server will not be available during upgrade.</p> <p>It is recommended, to perform a dry run before you do an in place upgrade. Keep in mind that an upgrade may fail, and you should have a cut-over plan to recover from that situation. For prototypes, and apps with very low service level objectives, it may be an option to simply do an in place upgrade. To do so, simply update your DBs config from e.g.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">13</span>
    <span class="c1"># ...</span>
</code></pre></div></div> <p>to:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgresqlFlexibleServers</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">version</span><span class="pi">:</span> <span class="m">14</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">Update</span>
    <span class="c1"># ...</span>
</code></pre></div></div> <h2 id="disaster-recovery"> <a href="#disaster-recovery" class="anchor-heading" aria-labelledby="disaster-recovery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Disaster Recovery </h2> <p>If you accidentally removed a database from your configuration, the database server will be deleted including all data.</p> <p>The UNITY team has undertaken several measures to recover from that disaster. In any case, you should open an incident as soon as possible, as time matters in this case. You will need the UNITY teams assistance in this case.</p> <p>It is made sure that a backup is created from your database before applying any changes such as destroying it. These backups are created using <code class="language-plaintext highlighter-rouge">pg_dump</code> and stored in a container. This container will be deleted together with a database. Unlike the deleted database server, it can be recovered for 30 days. That means, <strong>30 days after your database server was deleted, all data is deleted permanently</strong>.</p> </div> </div> <div class="search-overlay"></div> </div> <script> var config = { theme: "dark" } ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
